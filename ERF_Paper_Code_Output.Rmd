---
title: "ERF Paper"
author: "Tegveer Ghura"
date: "2023-02-10"
output: 
  html_document:
    code_folding: show
---

```{r setup, include=FALSE}
# import packages
library(naivebayes)
library(klaR)
library(e1071)
library(caTools)
library(caret)
library(tidyverse)
library(kableExtra)
library(stargazer)
library(flextable)
library(dplyr)
library(leaps)
library(caret)
library(ggplot2)
library(ggExtra)
library(tidyr)
library(ISLR2)
library(ISLR)
library(readr)
library(reticulate)
library(gtsummary)
library(stargazer)
library(randomForest)
library(ROCR)
library(pROC)
```

```{r df, warning=FALSE, message=FALSE}
# df import and subset
df <- read_csv('Data/REKT_Database_Clean_Python.csv') 
df <- subset(df, select = -c(...1, token_name, description, name_categories))
#df <- df %>% filter(funds_lost!=0)
```

```{r cleantext}
# Removing dictionary values from the scam_type column
df$scam_type <- gsub("[^:]*,[^:]*", "",df$scam_type)
df$scam_type <- gsub("'id'::", "",df$scam_type)
df$scam_type <- gsub("\\{|\\}", "",df$scam_type)
df$scam_type <- gsub("'", "",df$scam_type)
df$scam_type <- gsub("type: ", "",df$scam_type)
df$scam_type <- gsub(" ", "",df$scam_type)

# Removing list brackets from the scamNetworks column
df$scamNetworks <- gsub("\\[|\\]", "", df$scamNetworks)
df$scamNetworks <- gsub("'", '', df$scamNetworks)
df$scamNetworks <- gsub(", +", ",", df$scamNetworks) # remove whitespace after comma for grouping later
```

```{r scamtype}
# pooling together scam types into respective types 
df <- df %>% 
  mutate(scam_type_grouped = if_else(scam_type=="Honeypot" | scam_type=="Rugpull" | scam_type=="Abandoned" | project_name=="Kronos Dao" | project_name=="Genesis" | project_name=="Celsius Network" | project_name=="Voyager" | project_name=="BlockFi" | project_name=="FTX Group" | project_name=="Bitcoin Sheikh" | project_name=="Trade Coin Club" | project_name=="EmpiresX" | project_name=="Vauld", "Exit Scam", "Exploit"))
df <- subset(df, select = -c(scam_type, day_of_week_of_attack, day_of_year_of_attack, date, project_name))
table(df$scam_type_grouped)
```

```{r monthname}
#only month_of_attack has NA's (1873 of them), we can impute "unknown" for them or get rid of the column. Let's first see the performance from imputation
df$month_of_attack=month.name[df$month_of_attack]
df$month_of_attack[is.na(df$month_of_attack)] <- "Unknown"
#df <- na.omit(df)
```

```{r scamnetworks}
# pooling scamNetworks into 5 levels (Eth, binance, polygon, other centralized, other decentralized)
df <- separate_rows(df,scamNetworks,sep = ",")
df <- df %>% 
  mutate(scam_networks_grouped = if_else(scamNetworks == "Avax" | scamNetworks == "Algorand" | scamNetworks == "Arbitrum" | scamNetworks == "Cosmos" | scamNetworks == "Cronos" | scamNetworks == "Elastos" | scamNetworks == "Elrond" | scamNetworks == "EOS" | scamNetworks == "Fantom" | scamNetworks == "Fuse" | scamNetworks == "Gnosis" | scamNetworks == "Harmony" | scamNetworks == "Heco" | scamNetworks == "Klaytn" | scamNetworks == "KuCoin" | scamNetworks == "Moonriver" | scamNetworks == "Near" | scamNetworks == "OKExChain" | scamNetworks == "Optimism" | scamNetworks == "Ronin" | scamNetworks == "RSK" | scamNetworks == "Solana" | scamNetworks == "TRON" | scamNetworks == "Polkadot" | scamNetworks == "Other" | scamNetworks == "Terra Classic", "Other Decentralized", scamNetworks)) 
df <- df %>% filter(scam_networks_grouped != "") # remove empty string level
df <- subset(df, select = -c(scamNetworks))
```

```{r dtype}
# specify dtypes before train test split

df$scam_networks_grouped <- as.factor(df$scam_networks_grouped)
df$scam_type_grouped <-as.factor(df$scam_type_grouped)
df$month_of_attack <-as.factor(df$month_of_attack)

# add +1 because we have zeros in funds_returned and helps avoid negative inf values

df$log_funds_lost <- log(df$funds_lost + 1)
df$log_funds_returned <- log(df$funds_returned + 1) 
df <- subset(df, select = -c(funds_lost, funds_returned))
```


```{r rfmodel}
library(caret)

set.seed(3738)

df <- df[sample(1:nrow(df)), ] # shuffle rows

train.index <- createDataPartition(df$scam_networks_grouped, 
                                   p = .8, list = FALSE)
train <- df[ train.index,]
test  <- df[-train.index,]

x_train <- train %>% select(log_funds_lost, log_funds_returned, 
                            scam_networks_grouped)
y_train <- train$scam_type_grouped

x_test <- test %>% select(log_funds_lost, log_funds_returned, 
                          scam_networks_grouped)
y_test <- test$scam_type_grouped

classifier_RF <- randomForest(x = x_train,
                             y = y_train,
                             ntree = 500)

classifier_RF

# Predicting the Test set results
y_pred = predict(classifier_RF, newdata = x_test)

# Confusion Matrix
confusion_mtx = table(y_test, y_pred)
confusion_mtx
```

```{r logmodel}
library(caret)
set.seed(2377)
train.index <- createDataPartition(df$scam_networks_grouped, 
                                   p = .8, list = FALSE)
train <- df[ train.index,]
test  <- df[-train.index,]

train$scam_type_grouped = ifelse(train$scam_type_grouped  == "Exploit", 1, 0)
test$scam_type_grouped = ifelse(test$scam_type_grouped  == "Exploit", 1, 0)
logistic_model <- glm(scam_type_grouped ~ ., data = train, family = "binomial")
summary(logistic_model)
train_prob_pred <- predict(logistic_model, type = 'response', newdata = train)
test_prob_pred <- predict(logistic_model, type = 'response', newdata = test)
#y_pred = ifelse(prob_pred > 0.5, "Exploit", "Exit Scam")

# Train Confusion Matrix
y_train_pred = ifelse(train_prob_pred > 0.5, 1, 0)
y_train_pred<- as.factor(y_train_pred)
train$scam_type_grouped <- as.factor(train$scam_type_grouped)
(cm = table(train$scam_type_grouped, y_train_pred))

# Test Confusion Matrix
y_test_pred = ifelse(test_prob_pred > 0.5, 1, 0)
y_test_pred<- as.factor(y_test_pred)
test$scam_type_grouped <- as.factor(test$scam_type_grouped)
(cm = table(test$scam_type_grouped, y_test_pred)) # NAs ignored
#y_pred <- as.factor(unname(y_pred)) # for cfm plot
```

```{r cfmtrain}
# 1. Open jpeg file
#jpeg("Train_CFM.jpg", width = 350, height = 350)

library(scales)
ggplotConfusionMatrix <- function(m){
  mytitle <- paste("Train Accuracy", percent_format()(m$overall[1]))
  p <-
    ggplot(data = as.data.frame(m$table) ,
           aes(x = Prediction, y = Reference)) +
    geom_tile(aes(fill = log(Freq)), 
              colour = "white", show.legend = FALSE) +
    scale_fill_gradient(low = "white", high = "#56B1F7") +
    geom_text(aes(x = Prediction, y = Reference, 
                  label = Freq)) +
    ggtitle(mytitle) + 
    scale_x_discrete(limits = rev) +
    theme_minimal() + 
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank())
  return(p)
}
cfm_train <- confusionMatrix(train$scam_type_grouped, y_train_pred)
ggplotConfusionMatrix(cfm_train)

# Close the jpeg file
#dev.off() 
```


```{r cfmtest}
# Open jpeg file
#jpeg("Test_CFM.jpg", width = 350, height = 350)

library(scales)
ggplotConfusionMatrix <- function(m){
  mytitle <- paste("Test Accuracy", percent_format()(m$overall[1]))
  p <-
    ggplot(data = as.data.frame(m$table) ,
           aes(x = Prediction, y = Reference)) +
    geom_tile(aes(fill = log(Freq)), 
              colour = "white", show.legend = FALSE) +
    scale_fill_gradient(low = "white", high = "#56B1F7") +
    geom_text(aes(x = Prediction, y = Reference, 
                  label = Freq)) +
    ggtitle(mytitle) + 
    scale_x_discrete(limits = rev) +
    theme_minimal() + 
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank())
  return(p)
}
cfm_test <- confusionMatrix(test$scam_type_grouped, y_test_pred)
ggplotConfusionMatrix(cfm_test)

# Close the jpeg file
#dev.off() 
```

```{r roctraintest, message=FALSE, warning=FALSE}
# Train and Test Data ROC-AUC Curve
train_pred <- prediction(train_prob_pred, train$scam_type_grouped)
test_pred <- prediction(test_prob_pred, test$scam_type_grouped)

# Create an ROC curve
perf_train <- performance(train_pred, measure = "tpr", x.measure = "fpr")
perf_test <- performance(test_pred, measure = "tpr", x.measure = "fpr")

# Open a pdf and jpeg file
#pdf("ROC.pdf", width = 6.5, height = 4.24) 
#jpeg("ROC.jpg", width = 700, height = 350)


# Plot the ROC curve
plot(perf_train, main = "Logistic Regression AUC-ROC Curve",
    col = "#009ECE")
plot(perf_test, add = T, col = "#FF9E00", lwd = 1.5)
legend(0.32, 0.25, c("Train Data", "Test Data"), 
       col = c("#009ECE", "#FF9E00"), 
       bty = "n", lwd = 1.2, cex = 0.75)
abline(0, 1, lty = 2, col = "gray") # Add y=x line

# Close the pdf/jpeg file
#dev.off() 
```

```{r auctraintest, message=FALSE, warning=FALSE}
auc.train <- auc(train$scam_type_grouped, train_prob_pred)
cat("Area under the curve for Logistic Regression Train Set is: ", auc.train)
auc.test <- auc(train$scam_type_grouped, train_prob_pred)
cat("\nArea under the curve for Logistic Regressio  Test Set is: ", auc.test)
```
